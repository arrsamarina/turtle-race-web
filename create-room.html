<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã - –ß–µ—Ä–µ–ø–∞—à—å–∏ –±–µ–≥–∞</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="turtles-background" id="turtlesBackground"></div>

  <div class="main-container">
    <div class="content-box create-room-box">
      <div class="player-count-section">
        <div class="player-count-box">
          <h2 class="player-count-title">–ö–û–õ–ò–ß–ï–°–¢–í–û –ò–ì–†–û–ö–û–í</h2>
          <div class="player-count-options">
            <!-- –£–±—Ä–∞–ª–∏ –≤—ã–±–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –Ω–∏ –æ–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞, –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∫–ª–∏–∫–Ω–µ—Ç -->
            <button class="player-count-btn players-btn" data-players-count="2">
              <span class="player-count-number">2</span>
            </button>
            <button class="player-count-btn players-btn" data-players-count="3">
              <span class="player-count-number">3</span>
            </button>
            <button class="player-count-btn players-btn" data-players-count="4">
              <span class="player-count-number">4</span>
            </button>
            <button class="player-count-btn players-btn" data-players-count="5">
              <span class="player-count-number">5</span>
            </button>
          </div>
        </div>
      </div>

      <div class="turn-duration-section">
        <div class="turn-duration-box">
          <h2 class="turn-duration-title">–ü–†–û–î–û–õ–ñ–ò–¢–ï–õ–¨–ù–û–°–¢–¨ –•–û–î–ê</h2>
          <div class="turn-duration-options">
            <button class="turn-duration-btn duration-btn active" data-turn-duration="sec30">
              <span class="turn-duration-text">30 –°–ï–ö–£–ù–î</span>
            </button>
            <button class="turn-duration-btn duration-btn" data-turn-duration="sec60">
              <span class="turn-duration-text">60 –°–ï–ö–£–ù–î</span>
            </button>
          </div>
        </div>
      </div>

      <div class="create-button-section">
        <button type="button" class="btn create-btn">–°–û–ó–î–ê–¢–¨ –ö–û–ú–ù–ê–¢–£</button>
      </div>

      <div class="back-to-menu-section">
        <div class="back-to-menu">
          <a href="menu.html" class="back-to-menu-link">–≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</a>
        </div>
      </div>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script src="js/main.js"></script>

  <script>
    initTurtlesBackground('turtlesBackground');

    if (!checkAuth()) {
      window.location.href = 'login.html';
    }


    // –î–µ—Ñ–æ–ª—Ç—ã: –∏–≥—Ä–æ–∫–∏=2, –≤—Ä–µ–º—è=30
    let selectedPlayersCount = 2;
    let selectedTurnDuration = 'sec30';

    // --- –≤—ã–±–æ—Ä –∏–≥—Ä–æ–∫–æ–≤ ---
    const playerButtons = document.querySelectorAll('.players-btn');
    playerButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const count = parseInt(btn.getAttribute('data-players-count'), 10);
        if (!Number.isInteger(count) || count < 2 || count > 5) {
          alert('–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤');
          return;
        }
        selectedPlayersCount = count;

        playerButtons.forEach(b => b.classList.remove('active', 'selected', 'is-active'));
        btn.classList.add('active', 'selected', 'is-active');
      });
    });

    // --- –≤—ã–±–æ—Ä –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ---
    const durationButtons = document.querySelectorAll('.duration-btn');
    durationButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        selectedTurnDuration = btn.getAttribute('data-turn-duration');

        durationButtons.forEach(b => b.classList.remove('active', 'selected', 'is-active'));
        btn.classList.add('active', 'selected', 'is-active');
      });
    });

    function getTokenStrict() {
      const token = window.localStorage.getItem('token');
      console.log('[create-room] token from localStorage =', token);
      return token;
    }

    // --- –∂–µ–ª–µ–∑–Ω–æ–µ —Å—á–∏—Ç—ã–≤–∞–Ω–∏–µ –∏–∑ DOM –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π ---
    function readPlayersCountFromUI() {
      const btn = document.querySelector('.players-btn.active, .players-btn.selected, .players-btn.is-active');
      const v = btn ? parseInt(btn.getAttribute('data-players-count'), 10) : NaN;
      return v;
    }

    function readTurnDurationFromUI() {
      const btn = document.querySelector('.duration-btn.active, .duration-btn.selected, .duration-btn.is-active');
      return btn ? btn.getAttribute('data-turn-duration') : null;
    }


    document.querySelector('.create-btn').addEventListener('click', async () => {
      const token = getTokenStrict();

      if (!token) {
        alert('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ');
        window.location.href = 'login.html';
        return;
      }

      // 1) —á–∏—Ç–∞–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ UI
      const playersCountToSend = readPlayersCountFromUI();
      const turnDurationToSend = readTurnDurationFromUI();

      console.log('[create-room] üìå UI snapshot before send:', {
        playersCountToSend,
        turnDurationToSend,
        selectedPlayersCount_var: selectedPlayersCount,
        selectedTurnDuration_var: selectedTurnDuration,
      });

      if (!Number.isInteger(playersCountToSend) || playersCountToSend < 2 || playersCountToSend > 5) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (2‚Äì5).');
        return;
      }

      if (!['sec30','sec60'].includes(turnDurationToSend)) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ö–æ–¥–∞ (30/60).');
        return;
      }

      // 2) —Å–æ–∑–¥–∞—ë–º –∫–æ–º–Ω–∞—Ç—É (–≤—Å–µ –∫–æ–º–Ω–∞—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã–µ)
      try {
        const res = await apiCreateRoom({
          token,
          players_count: playersCountToSend,
          turn_duration: turnDurationToSend
        });

        console.log('[create-room] –û—Ç–≤–µ—Ç create_room:', res);

        if (res.status === 'ok') {
          // –ü–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ create_game_room –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
          // { "status": "ok", "game": { "id": 1, "players_max": 2, ... }, "me": { ... } }
          const gameId =
            res.game?.id ||          // –û—Å–Ω–æ–≤–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ –Ω–æ–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
            res.id_game ||           // Fallback –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
            res.game?.id_game ||
            res.game_id ||
            res.data?.game?.id ||
            res.data?.id_game ||
            res.data?.game_id;

          if (!gameId) {
            console.error('[create-room] –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ ID –∏–≥—Ä—ã –≤ –æ—Ç–≤–µ—Ç–µ:', res);
            alert('–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª ID –∏–≥—Ä—ã');
            return;
          }

          // –ü–µ—Ä–µ–¥–∞—ë–º –≤ –ª–æ–±–±–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤,
          // —á—Ç–æ–±—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –æ–∂–∏–¥–∞–µ–º–æ–µ —á–∏—Å–ª–æ —Å–ª–æ—Ç–æ–≤.
          window.location.href = `room-lobby.html?id=${gameId}&slots=${playersCountToSend}`;
        } else {
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
          let errorMessage = res.message || res.error || 'unknown_error';
          if (res.error === 'invalid_players_count') {
            errorMessage = '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤. –î–æ–ø—É—Å—Ç–∏–º–æ: 2, 3, 4 –∏–ª–∏ 5';
          } else if (res.error === 'invalid_turn_duration') {
            errorMessage = '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ö–æ–¥–∞. –î–æ–ø—É—Å—Ç–∏–º–æ: sec30 –∏–ª–∏ sec60';
          } else if (res.error === 'invalid_token') {
            errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω. –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è';
            window.location.href = 'login.html';
            return;
          }
          alert('–û—à–∏–±–∫–∞: ' + errorMessage);
        }
      } catch (e) {
        console.error(e);
        alert('–û—à–∏–±–∫–∞: ' + e.message);
      }
    });
  </script>
</body>
</html>
